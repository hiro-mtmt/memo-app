# メモアプリ技術スタック詳細

## プロジェクト概要

**名称**: Markdown メモアプリ
**アーキテクチャ**: デスクトップアプリケーション（Tauri + React）
**目的**: 軽量で高速なマークダウン対応メモアプリケーション

---

## アーキテクチャ構成

```
┌─────────────────────────────────────┐
│         フロントエンド (React)        │
│    - UI コンポーネント                │
│    - 状態管理                        │
│    - マークダウンエディタ/プレビュー   │
│    - ドラッグ&ドロップ (並べ替え/インポート) │
└──────────────┬──────────────────────┘
               │ Tauri IPC (invoke)
┌──────────────▼──────────────────────┐
│      バックエンド (Rust/Tauri)       │
│    - ファイルシステム操作             │
│    - メモCRUD                        │
│    - ピン管理                        │
│    - 順序管理                        │
│    - ファイルインポート               │
│    - ネイティブダイアログ             │
└─────────────────────────────────────┘
               │
┌──────────────▼──────────────────────┐
│      ファイルシステム                 │
│    ~/Documents/Memos/*.md           │
│    ~/.memo-app/config.json          │
│    ~/Documents/Memos/.pins.json     │
│    ~/Documents/Memos/.order.json    │
└─────────────────────────────────────┘
```

---

## フロントエンド技術

### コア技術

#### 1. **React 19.2.4**
- **役割**: UI ライブラリ
- **使用理由**:
  - コンポーネントベースの設計
  - 効率的な仮想 DOM
  - 豊富なエコシステム
- **主な機能**:
  - 関数コンポーネント
  - Hooks (useState, useEffect, useRef)
  - イベントハンドリング

#### 2. **TypeScript 5.9.3**
- **バージョン**: ES2020
- **役割**: 型安全な JavaScript
- **設定**:
  - `strict: true` - 厳格な型チェック
  - `noUnusedLocals: true`
  - `noUnusedParameters: true`
  - `jsx: "react-jsx"`
- **利点**:
  - コンパイル時の型エラー検出
  - IntelliSense サポート
  - リファクタリングの安全性

#### 3. **Vite 7.3.1**
- **役割**: ビルドツール & 開発サーバー
- **機能**:
  - 高速な HMR (Hot Module Replacement)
  - ES モジュールベースの開発
  - 最適化されたプロダクションビルド
- **設定**:
  ```typescript
  {
    clearScreen: false,
    server: {
      port: 5175,
      strictPort: true
    },
    envPrefix: ['VITE_', 'TAURI_']
  }
  ```

### UI ライブラリ

#### 4. **CodeMirror 6** (@uiw/react-codemirror ^4.25.4)
- **パッケージ**:
  - `@uiw/react-codemirror` - React ラッパー
  - `@codemirror/lang-markdown` - Markdown シンタックス
- **役割**: マークダウンエディタ
- **機能**:
  - シンタックスハイライト
  - オートインデント
  - キーボードショートカット
  - 拡張可能なエディタシステム

#### 5. **react-markdown ^10.1.0**
- **役割**: Mdプレビュー
- **プラグイン**:
  - `remark-gfm` ^4.0.1 - GitHub Flavored Markdown サポート
- **サポート機能**:
  - 見出し、リスト、コードブロック
  - テーブル、取り消し線、タスクリスト
  - リンク、画像

#### 6. **react-resizable-panels ^4.6.2**
- **役割**: エディタ/プレビューのリサイズ可能パネル
- **使用コンポーネント**:
  - `Panel` - 各パネル領域
  - `Group` (as PanelGroup) - パネルグループ
  - `Separator` (as PanelResizeHandle) - リサイズハンドル
- **機能**:
  - ドラッグでパネル幅を調整
  - `orientation="horizontal"` で横分割

#### 7. **react-icons ^5.5.0**
- **役割**: アイコンライブラリ
- **使用セット**: Ionicons 5 (io5)
- **使用アイコン**:
  - `IoAdd` - 新規作成
  - `IoPin` - ピン留め
  - `IoClose` - 削除
  - `IoSave` - 保存
  - `IoEye` / `IoEyeOff` - プレビュー切替
  - `IoPencil` - 編集モード
  - `IoReorderThreeOutline` - ドラッグハンドル
  - `IoChevronBackOutline` / `IoChevronForwardOutline` - リスト折りたたみ
  - `IoHelpCircle` - ヘルプ
  - `IoDocumentAttach` - ファイルインポート

#### 8. **@dnd-kit** (ドラッグ&ドロップ)
- **パッケージ**:
  - `@dnd-kit/core` ^6.3.1 - コアライブラリ
  - `@dnd-kit/sortable` ^10.0.0 - ソート機能
  - `@dnd-kit/utilities` ^3.2.2 - ユーティリティ
- **役割**: メモリストの並べ替え
- **機能**:
  - `DndContext` + `SortableContext` によるソート対応
  - `PointerSensor` / `KeyboardSensor` による操作
  - `verticalListSortingStrategy` で縦方向ソート
  - ピン留めメモと未ピンメモ間の移動制限

### 状態管理

#### 9. **カスタムフック**
- **useMemos**: メモの CRUD 操作
  ```typescript
  - loadMemos(): メモ一覧取得
  - createMemo(): 新規メモ作成（ピン留めメモの下に挿入）
  - deleteMemo(): メモ削除
  - reloadMemos(): リスト再読み込み
  - importFromDialog(): ファイルダイアログからインポート
  - importFromDrop(): ドラッグ&ドロップからインポート
  ```

- **useAutoSave**: 自動保存機能
  ```typescript
  - デバウンス処理: 1000ms
  - 変更検出
  - 自動ファイル保存
  - ファイル名変更時の通知
  ```

---

## バックエンド技術

### コア技術

#### 10. **Tauri 1.8.1**
- **役割**: デスクトップアプリフレームワーク
- **features**: `["dialog"]` - ネイティブファイル選択ダイアログ
- **特徴**:
  - Rust ベースのバックエンド
  - ネイティブ API アクセス
  - 軽量 (10-15MB)
  - セキュア (明示的な権限管理)
- **アーキテクチャ**:
  - WebView (システムのブラウザエンジン使用)
  - IPC 通信 (invoke/emit)
- **設定** (tauri.conf.json):
  - `fileDropEnabled: false` - ブラウザ側でファイルドロップを処理するため Tauri のデフォルトドロップ処理を無効化

#### 11. **Rust 1.60+**
- **役割**: バックエンドロジック
- **使用箇所**:
  - ファイルシステム操作
  - メモ管理
  - 設定管理
  - ピン留め機能
  - 順序管理
  - ファイルインポート (ダイアログ + コンテンツ)

### Rust依存関係

#### 12. **serde / serde_json**
- **バージョン**: 1.0
- **役割**: シリアライゼーション/デシリアライゼーション
- **用途**:
  - JSON ⇔ Rust 構造体の変換
  - 設定ファイルの読み書き
  - IPC データの送受信

#### 13. **chrono**
- **バージョン**: 0.4
- **役割**: 日時処理
- **機能**:
  - ISO 8601 形式の日時
  - タイムゾーン対応
  - 日時の比較・計算

#### 14. **dirs**
- **バージョン**: 5.0
- **役割**: ディレクトリパス取得
- **用途**:
  - ホームディレクトリ取得
  - ドキュメントフォルダパス
  - 設定ファイルパス

---

## ファイル構造

### フロントエンド

```
src/
├── components/
│   ├── Editor/
│   │   └── MarkdownEditor.tsx      # CodeMirror エディタ
│   ├── Preview/
│   │   └── MarkdownPreview.tsx     # react-markdown Mdプレビュー
│   ├── Layout/
│   │   ├── MainLayout.tsx          # メインレイアウト（リサイズパネル、D&D）
│   │   └── MainLayout.css          # スタイル
│   └── Help/
│       ├── MarkdownHelp.tsx        # ヘルプモーダル
│       └── MarkdownHelp.css        # モーダルスタイル
├── hooks/
│   ├── useMemos.ts                 # メモ管理フック（CRUD + インポート）
│   └── useAutoSave.ts              # 自動保存フック
├── services/
│   ├── fileService.ts              # ファイル操作サービス（インポート含む）
│   ├── configService.ts            # 設定管理サービス
│   └── tauriTypes.ts               # Rust 型定義
├── types/
│   └── memo.ts                     # TypeScript 型定義
├── utils/
│   ├── sanitize.ts                 # ファイル名サニタイズ
│   └── extractTitle.ts             # タイトル抽出
├── App.tsx                         # ルートコンポーネント
└── main.tsx                        # エントリーポイント
```

### バックエンド

```
src-tauri/
├── src/
│   ├── commands/
│   │   ├── mod.rs                  # モジュール定義
│   │   ├── memo.rs                 # メモ CRUD + インポート + 順序管理
│   │   └── config.rs               # 設定コマンド
│   ├── utils/
│   │   └── paths.rs                # パスユーティリティ
│   └── main.rs                     # エントリーポイント
├── tauri.conf.json                 # Tauri 設定
└── Cargo.toml                      # Rust 依存関係
```

---

## 主要機能と実装技術

### 1. メモ管理 (CRUD)

**技術スタック**:
- フロントエンド: React Hooks, TypeScript
- バックエンド: Rust, std::fs
- データ形式: Markdown (.md)

**実装**:
```rust
// Rust コマンド
#[tauri::command]
pub fn list_memos() -> Result<Vec<MemoMetadata>, String>
pub fn read_memo(filename: String) -> Result<MemoMetadata, String>
pub fn save_memo(title: String, content: String, old_filename: Option<String>) -> Result<String, String>
pub fn delete_memo(filename: String) -> Result<(), String>
pub fn create_memo() -> Result<MemoMetadata, String>
```

```typescript
// TypeScript サービス
export async function loadMemos(): Promise<Memo[]>
export async function saveMemo(title: string, content: string, oldFilename?: string): Promise<string>
export async function deleteMemo(filename: string): Promise<void>
export async function createMemo(): Promise<Memo>
```

### 2. マークダウンエディタ

**技術**: CodeMirror 6 (@uiw/react-codemirror)

**拡張機能**:
- `markdown()` - Markdown シンタックス
- `lineNumbers()` - 行番号表示
- `EditorView.lineWrapping` - 折り返し
- `defaultKeymap`, `historyKeymap` - キーボードショートカット

**特徴**:
- リアルタイムシンタックスハイライト
- Undo/Redo サポート
- カスタマイズ可能なテーマ

### 3. Mdプレビュー機能

**技術**: react-markdown + remark-gfm

**サポート記法**:
- 見出し (H1-H6)
- リスト (順序付き/なし)
- コードブロック (シンタックスハイライト)
- テーブル
- タスクリスト
- 取り消し線
- リンク、画像

### 4. リサイズ可能パネル

**技術**: react-resizable-panels v4

**構成**:
- エディタとプレビューの2パネル構成
- ドラッグでパネル幅を調整可能
- 各パネルは最小幅30%
- エディタのみ / プレビューのみ / 両方表示の3モード切替

### 5. 自動保存

**技術**: React useEffect + デバウンス

**仕組み**:
```typescript
// 1秒間編集がなければ自動保存
useEffect(() => {
  const timer = setTimeout(async () => {
    await saveMemo(title, content, filename);
  }, 1000);

  return () => clearTimeout(timer);
}, [content]);
```

### 6. ピン留め機能

**技術**:
- データ保存: JSON ファイル (.pins.json)
- 状態管理: HashMap<String, PinData>
- ソート: カスタム比較関数
- ピン留めメモは削除不可（先にピン解除が必要）

**実装**:
```rust
// ピンデータ構造
struct PinData {
    pinned: bool,
    pinned_at: Option<String>,
}

// ソートロジック
memos.sort_by(|a, b| {
    match (a.pinned, b.pinned) {
        (true, false) => Ordering::Less,    // ピン済みを上に
        (false, true) => Ordering::Greater,
        (true, true) => /* カスタム順序 → pinned_at */,
        (false, false) => /* カスタム順序 → updated_at */,
    }
});
```

### 7. メモ順序管理

**技術**:
- データ保存: JSON ファイル (.order.json)
- 状態管理: HashMap<String, usize>
- フロントエンド: @dnd-kit によるドラッグ&ドロップ

**仕組み**:
- ピン留めメモと未ピンメモは別グループとして順序管理
- ピン留め ⇔ 未ピン間のドラッグ移動は禁止
- `list_memos` 実行時に未登録メモの順序を自動永続化（`updated_at` フォールバックを防止）
- `save_memo` でファイル名変更時に `.order.json` の順序を引き継ぎ
- 新規作成メモはピン留めメモの直後（未ピンの先頭）に挿入

```rust
// Rust コマンド
pub fn update_memo_order(filenames: Vec<String>) -> Result<(), String>
```

### 8. ファイルインポート

**技術**:
- ネイティブダイアログ: `tauri::api::dialog::blocking::FileDialogBuilder`
- ブラウザ D&D: HTML5 Drag and Drop API
- 非同期処理: `tauri::async_runtime::spawn_blocking`

**対応フォーマット**: .md, .txt

**2つのインポート方法**:

1. **ファイルダイアログ**: サイドバーのインポートボタンからOS標準のファイル選択ダイアログを開く
2. **ドラッグ&ドロップ**: OSからメモリストエリアにファイルをドロップ

**実装**:
```rust
// Rust コマンド
pub async fn import_memo_from_dialog() -> Result<Vec<MemoMetadata>, String>
pub fn import_memo_from_content(original_filename: String, content: String) -> Result<MemoMetadata, String>
```

```typescript
// TypeScript サービス
export async function importMemosFromDialog(): Promise<Memo[]>
export async function importMemoFromContent(originalFilename: string, content: string): Promise<Memo>
```

**重複ファイル名の処理**:
- 同名ファイルが存在する場合、`_1`, `_2` ... を自動付与

### 9. ヘルプモーダル

**技術**: React State + CSS

**機能**:
- モーダルオーバーレイ
- スクロール可能なコンテンツ
- アニメーション (fadeIn, slideUp)
- アクセシビリティ (ESC キーで閉じる)

---

## スタイリング

### CSS 設計

**方式**: コンポーネントスコープ CSS

**主な技術**:
- Flexbox レイアウト
- CSS トランジション/アニメーション
- レスポンシブデザイン
- カスタムスクロールバー

**カラースキーム**:
```css
プライマリ: #007bff (青)
セカンダリ: #6c757d (グレー)
警告: #ffc107 (黄色)
危険: #ffcdd2 (薄赤) → #ef5350 (赤)
成功: #28a745 (緑)
インポート: #17a2b8 (ティール)
ドロップゾーン: #5a9fd4 (青)
```

**レイアウト構成**:
```
├─ 左ペイン: メモリスト (折りたたみ可能)
├─ 中央ペイン: エディタ (リサイズ可能)
└─ 右ペイン: Mdプレビュー (リサイズ可能、切替可能)
```

**UIコンポーネント**:
- ドラッグハンドル付きメモアイテム
- ピン留め/削除ボタン
- インポートボタン (ティール色の円形ボタン)
- ドラッグ&ドロップ プレースホルダー (青い点線枠)
- ドラッグオーバーレイ (青い半透明背景)

---

## データフロー

### メモの読み込み

```
User Action
    ↓
useMemos.loadMemos() (React Hook)
    ↓
fileService.loadMemos() (TypeScript)
    ↓
invoke('list_memos') (Tauri IPC)
    ↓
list_memos() (Rust Command)
    ↓
fs::read_dir() (File System)
    ↓
Sort + Auto-persist order (.order.json)
    ↓
MemoMetadata[] (JSON)
    ↓
Memo[] (TypeScript)
    ↓
State Update (React)
    ↓
UI Re-render
```

### メモの保存

```
User Types
    ↓
onChange Event
    ↓
setEditingContent() (React State)
    ↓
useAutoSave Hook (1秒デバウンス)
    ↓
fileService.saveMemo()
    ↓
invoke('save_memo')
    ↓
save_memo() (Rust)
    ↓
fs::write() + .order.json 更新 (File System)
    ↓
Success/Error Response
    ↓
State Update
```

### ファイルインポート (ダイアログ)

```
User Clicks Import Button
    ↓
handleImportMemo() (App.tsx)
    ↓
useMemos.importFromDialog()
    ↓
fileService.importMemosFromDialog()
    ↓
invoke('import_memo_from_dialog') (Tauri IPC)
    ↓
spawn_blocking → FileDialogBuilder (Native Dialog)
    ↓
User Selects Files
    ↓
import_single_file() × N (Rust)
    ↓
resolve_unique_filename() → fs::write()
    ↓
MemoMetadata[] → Memo[]
    ↓
reloadMemos() → Auto Select Imported Memo
```

### ファイルインポート (ドラッグ&ドロップ)

```
User Drags File from OS
    ↓
onDragOver → isDragOver=true (Drop Overlay)
    ↓
onDrop → Filter .md/.txt files
    ↓
readFileAsText() (FileReader API)
    ↓
handleDropFiles() (App.tsx)
    ↓
useMemos.importFromDrop(filename, content)
    ↓
invoke('import_memo_from_content') (Tauri IPC)
    ↓
resolve_unique_filename() → fs::write() (Rust)
    ↓
MemoMetadata → Memo
    ↓
reloadMemos() → Auto Select Imported Memo
```

---

## セキュリティ

### Tauri セキュリティモデル

1. **明示的な権限**:
   - ファイルシステムアクセスは Rust コマンド経由のみ
   - フロントエンドから直接ファイルアクセス不可

2. **Command ホワイトリスト**:
   ```rust
   invoke_handler![
       list_memos,
       read_memo,
       save_memo,
       delete_memo,
       create_memo,
       toggle_pin,
       update_memo_order,
       import_memo_from_dialog,
       import_memo_from_content,
       get_config,
       save_config,
       update_config,
   ]
   ```

3. **入力検証**:
   - ファイル名サニタイズ
   - パスインジェクション防止
   - 拡張子チェック (.md, .txt のみインポート可)
   - 重複ファイル名の自動解決

---

## パフォーマンス最適化

### 1. 軽量化
- **バンドルサイズ**: 10-15MB (Electron: 150MB と比較)
- **メモリ使用量**: 50-80MB (Electron: 200MB と比較)
- **起動速度**: 0.5-1秒

### 2. 最適化技術
- **Tree Shaking**: Vite による未使用コード削除
- **Code Splitting**: 動的インポート
- **Debounce**: 自動保存の頻度制限 (1秒)
- **Virtual DOM**: React の効率的な更新
- **順序安定化**: .order.json による自動永続化で不要な再ソートを防止
- **選択時の不要保存回避**: 内容未変更時は保存スキップ

### 3. キャッシング
- **ファイル読み込み**: メモリキャッシュ
- **ピンデータ**: JSON ファイルキャッシュ
- **順序データ**: JSON ファイルキャッシュ

---

## 開発ツール

### パッケージマネージャー
- **npm** (Node.js パッケージ管理)
- **Cargo** (Rust パッケージ管理)

### 開発コマンド

```bash
# 開発サーバー起動 (Tauri + Vite)
npm run dev

# Vite のみ起動
npm run vite

# プロダクションビルド
npm run build

# Rust コンパイル
cargo build --release
```

### 型チェック
- **TypeScript Compiler** (tsc)
- **Rust Compiler** (rustc)

---

## 依存関係まとめ

### フロントエンド (package.json)

```json
{
  "dependencies": {
    "react": "^19.2.4",
    "react-dom": "^19.2.4",
    "@uiw/react-codemirror": "^4.25.4",
    "@codemirror/lang-markdown": "^6.5.0",
    "react-markdown": "^10.1.0",
    "remark-gfm": "^4.0.1",
    "react-resizable-panels": "^4.6.2",
    "react-icons": "^5.5.0",
    "@dnd-kit/core": "^6.3.1",
    "@dnd-kit/sortable": "^10.0.0",
    "@dnd-kit/utilities": "^3.2.2"
  },
  "devDependencies": {
    "@tauri-apps/api": "^1.6.0",
    "@tauri-apps/cli": "^1.6.3",
    "@types/node": "^25.2.3",
    "@types/react": "^19.2.14",
    "@types/react-dom": "^19.2.3",
    "@vitejs/plugin-react": "^5.1.4",
    "typescript": "^5.9.3",
    "vite": "^7.3.1"
  }
}
```

### バックエンド (Cargo.toml)

```toml
[dependencies]
tauri = { version = "1.8.1", features = ["dialog"] }
serde = { version = "1.0", features = ["derive"] }
serde_json = "1.0"
chrono = { version = "0.4", features = ["serde"] }
dirs = "5.0"

[build-dependencies]
tauri-build = { version = "1.5.5" }
```

---

## まとめ

このメモアプリは、モダンな Web 技術 (React, TypeScript) と高性能なネイティブ技術 (Rust, Tauri) を組み合わせることで、**軽量**・**高速**・**セキュア**なデスクトップアプリケーションを実現しています。

**主な技術的特徴**:
- Tauri による軽量化 (90% サイズ削減)
- React + TypeScript による型安全な開発
- CodeMirror 6 による高機能エディタ
- react-resizable-panels によるリサイズ可能パネル
- @dnd-kit によるドラッグ&ドロップ並べ替え
- Rust による高速ファイル操作
- 自動保存・ピン留め・順序管理
- ファイルインポート (ダイアログ + D&D)
- マークダウン完全サポート (GFM)
